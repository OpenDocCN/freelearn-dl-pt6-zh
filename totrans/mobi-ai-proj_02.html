<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Creating a Real-Estate Price Prediction Mobile App</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we covered the theoretical fundamentals; this chapter, on the other hand, will cover the setup of all the tools and libraries.</p>
<p>First, we are going to set up our environment to build a Keras model to predict house prices with real estate data. Then we are going to serve this model using a RESTful API built using Flask. Next, we will set up our environment for Android and create an app that will consume this RESTful API to predict the house price based on features of real estate. Finally, we will repeat the same exercise for iOS. </p>
<p>The focus of this chapter is on the setup, tools, libraries, and exercising the concepts learned in <a href="1bfa8853-a79e-4b4a-aa9f-254392b158bb.xhtml" target="_blank"/><a href="1bfa8853-a79e-4b4a-aa9f-254392b158bb.xhtml">Chapter 1</a>, <em>Artificial Intelligence Concepts and Fundamentals</em>. The use case is designed to be simple, yet adaptable enough to accommodate similar use-cases. By the end of the chapter, you will be comfortable creating a mobile app for prediction or classification use cases.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Setting up the artificial intelligence environment</li>
<li>Building an ANN model for prediction using Keras and Tenserflow</li>
<li>Serving the model as an API</li>
<li>Creating an Android app to predict house prices</li>
<li>Creating an iOS app to predict house prices</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up the artificial intelligence environment </h1>
                </header>
            
            <article>
                
<p>The first thing to do is install Python. We are going to use Python throughout this book for all our <strong>artificial intelligence</strong> (<strong>AI</strong>) tasks. There are two ways to install Python, either through the downloadable executable file provided from <a href="https://www.python.org/downloads/" target="_blank">https://www.python.org/downloads/</a> or via Anaconda. Our approach will be the latter, that is, using Anaconda.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Downloading and installing Anaconda</h1>
                </header>
            
            <article>
                
<p>Now, let's go to the official Anaconda installation page (<a href="https://conda.io/docs/user-guide/install/index.html#regular-installation">https://conda.io/docs/user-guide/install/index.html#regular-installation</a>) and choose the appropriate option based on your operating system:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7ad40de0-48bf-4274-a70a-48405c216193.jpg" style="width:50.08em;height:34.17em;"/></p>
<p>Follow the instructions as per the documentation. The installation takes some time. </p>
<p class="mce-root"/>
<p>Once it is installed, let's test the installation. Open the command prompt and type the <kbd>conda list</kbd> command. You should see a list of libraries and packages that have been installed as part of the Anaconda installation:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-856 image-border" src="assets/eaf4227c-4431-4666-9847-a5810508a2dc.png" style="width:40.08em;height:28.33em;"/></p>
<p>If you do not get this output, please follow the official documentation page we saw and try again.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Advantages of Anaconda</h1>
                </header>
            
            <article>
                
<p>Let's discuss a few positives of using a package-management tool:</p>
<ul>
<li>Anaconda lets us create environments to install libraries and packages. This environment is completely independent of the operating system or admin libraries. This means we can create user-level environments with custom versions of libraries for specific projects, which helps us port the project across operating systems with minimal effort.</li>
<li>Anaconda can have multiple environments with different versions of Python and supporting libraries. This way, any version mismatch can be avoided and is not affected by existing packages and libraries of the operating system.</li>
</ul>
<ul>
<li>Anaconda comes preloaded with most of necessary packages and libraries for data-science-related tasks, including a highly popular and interactive Python editor called Jupyter Notebook. Throughout this book, we will be using Jupyter Notebook a lot, mostly when we need to interactively code our tasks.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an Anaconda environment</h1>
                </header>
            
            <article>
                
<p>We will create an environment named <kbd>ai-projects</kbd> that uses Python version 3.6. All our dependencies are going to be installed in this environment:</p>
<pre><strong>conda create -n ai-projects python=3.6 anaconda</strong></pre>
<p>Now, proceed and accept the prompts that you are presented with, you should get an output that looks as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-857 image-border" src="assets/0e2e117d-df7b-4639-a8b6-c7e28ff6b533.png" style="width:41.50em;height:33.42em;"/></p>
<p>Before we start installing the dependencies, we need to activate the environment we just created using the <kbd>activate ai-projects</kbd> command, or <kbd>source activate ai-projects</kbd> if you are using bash shell. The prompt will change to indicate that the environment has been activated:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-858 image-border" src="assets/6ea56944-b878-4bff-996f-a04e75176c77.png" style="width:55.92em;height:29.50em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing dependencies</h1>
                </header>
            
            <article>
                
<p class="mce-root">First, let's install TensorFlow. It is an open source framework for building <strong>Artificial Neural Network</strong> (<strong>ANN</strong>):</p>
<pre><strong>pip install tensorflow</strong></pre>
<p>You should see the following output, which indicates a successful installation:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b31ba28b-8559-4a06-872c-9d6f6b0a3c23.jpg" style="width:59.92em;height:34.58em;"/></p>
<p>We can also manually check the installation. Type <kbd>python</kbd> to open the Python prompt on the command line. Once inside the Python prompt, type <kbd>import tensorflow</kbd> and hit <em>Enter</em>. You should see the following output:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c27ee804-673f-4076-aaf8-9cdbe2fa926c.png" style="width:73.58em;height:22.92em;"/></p>
<p>Type <kbd>exit()</kbd> to return to the default command line, keep in mind that we are still inside the <kbd>ai-projects</kbd> conda environment.</p>
<p class="mce-root"/>
<p>Next, we are going to install Keras, a wrapper over TensorFlow that makes designing deep neural networks much more intuitive. We continue to use the <kbd>pip</kbd> command:</p>
<pre><strong>pip install keras</strong></pre>
<p>On successful installation, we should see the following output:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c0c4df7c-c974-497b-8602-3630003cd1b9.jpg" style="width:63.92em;height:36.17em;"/></p>
<p>To manually check the installation, type <kbd>python</kbd> to open the Python prompt on the command line. Once inside the Python prompt, type <kbd>import keras</kbd> and hit <em>Enter</em>. You should see the following output, with no errors. Observe that the output mentions that Keras is using TensorFlow as its backend:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/aaa69964-684b-40a2-86f6-8612d33bd511.jpg" style="width:50.33em;height:14.17em;"/></p>
<p>Great! We have now installed the main dependencies required to create our very own neural networks. Let's go ahead and build an ANN to predict real estate prices.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building an ANN model for prediction using Keras and TensorFlow</h1>
                </header>
            
            <article>
                
<p>Now that we have our libraries installed, let's create a folder called <kbd>aibook</kbd> and within that create another folder called <kbd>chapter2</kbd>. Move all the code for this chapter into the <kbd>chapter2</kbd> folder. Make sure that the conda environment is still active (the prompt will start with the environment name):</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2f8d52ea-805c-46a4-8937-ef6c14f333d2.jpg"/></p>
<p><span>Once within the </span><kbd>chapter2</kbd><span> folder, type </span><kbd>jupyter notebook</kbd><span>. This will open an interactive Python editor on the browser.</span></p>
<p><span>Use the</span> <span class="packt_screen">New</span><span> dropdown in the top-right corner to create a new <span class="packt_screen">Python 3</span> notebook</span><span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-860 image-border" src="assets/e30c7760-1f13-4aa1-ab80-9b62b18f8643.png" style="width:37.67em;height:15.17em;"/></p>
<p>We are now ready to build our first ANN using Keras and TensorFlow, to predict real estate prices:</p>
<ol>
<li>Import all the libraries that we need for this exercise. Use the first cell to import all the libraries and run it. Here are the four main libraries we will use:</li>
</ol>
<ul>
<li style="list-style-type: none">
<ul>
<li><kbd>pandas</kbd>: We use this to read the data and store it in a dataframe</li>
<li><kbd>sklearn</kbd>: We use this to standardize data and for k-fold cross-validation</li>
<li><kbd>keras</kbd>: We use this to build our sequential neural network</li>
<li><kbd>numpy</kbd>: We use <kbd>numpy</kbd> for all math and array operations</li>
</ul>
</li>
</ul>
<p style="padding-left: 60px">Let's import these libraries:</p>
<pre class="mce-root" style="padding-left: 60px">import numpy<br/>import pandas as pd<br/>from keras.models import Sequential<br/>from keras.layers import Dense<br/>from keras import optimizers<br/>from keras.wrappers.scikit_learn import KerasRegressor<br/>from sklearn.model_selection import cross_val_score<br/>from sklearn.model_selection import KFold<br/>from sklearn.preprocessing import StandardScaler<br/>from sklearn.pipeline import Pipeline<strong><br/></strong></pre>
<ol start="2">
<li>Load the real estate housing data using <kbd>pandas</kbd>:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px">dataframe = pd.read_csv("housing.csv", sep=',', header=0)<br/>dataset = dataframe.values</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="3">
<li>To view the feature variables, the target variables, and a few rows of the data, enter the following:</li>
</ol>
<pre style="padding-left: 60px">dataframe.head()<strong> </strong></pre>
<p>This output will be a few rows of <kbd>dataframe</kbd>, which is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-861 image-border" src="assets/251b1699-eadc-4873-a7ae-87182e276c88.png" style="width:36.67em;height:12.00em;"/></p>
<p>The dataset has eight columns, details of each column are given as follows:</p>
<ul>
<li><span class="packt_screen">BIZPROP</span>: Proportion of non-retail business acres per town</li>
<li><span class="packt_screen">ROOMS</span>: Average number of rooms per dwelling</li>
<li><span class="packt_screen">AGE</span>: Proportion of owner-occupied units built before 1940</li>
<li><span class="packt_screen">HIGHWAYS</span>: Index of accessibility to radial highways</li>
<li><span class="packt_screen">TAX</span>: Full-value property tax rate per $10,000</li>
<li><span class="packt_screen">PTRATIO</span>: Pupil-to-teacher ratio by town</li>
<li><span class="packt_screen">LSTAT</span>: Percentage of lower status of the population</li>
<li><span class="packt_screen">VALUE</span>: Median value of owner-occupied homes in thousand dollars (target variable)</li>
</ul>
<p>In our use case, we need to predict the <span class="packt_screen">VALUE</span> column, so we need to split the dataframe into features and target values. We will use a 70/30 split, that is, 70% of data for training and 30% data for testing:</p>
<pre>features = dataset[:,0:7]<br/>target = dataset[:,7]</pre>
<p>Also, to make sure we can reproduce the results, let's set a seed for random generation. This random function is used during cross-validation to randomly sample the data:</p>
<pre class="mce-root"># fix random seed for reproducibility <br/>seed = 9 <br/>numpy.random.seed(seed)</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Now we are ready to build our ANN:</p>
<ol>
<li>Create a sequential neural network that has a simple and shallow architecture.</li>
<li>Make a function called <kbd>simple_shallow_seq_net()</kbd> that will define the architecture of the neural network:</li>
</ol>
<pre style="padding-left: 60px">def simple_shallow_seq_net():<br/>   # create a sequential ANN <br/>    model = Sequential() <br/>    model.add(Dense(7, input_dim=7, kernel_initializer='normal', activation='sigmoid')) <br/>    model.add(Dense(1, kernel_initializer='normal')) <br/>    sgd = optimizers.SGD(lr=0.01) <br/>    model.compile(loss='mean_squared_error', optimizer=sgd) <br/>    return model</pre>
<ol start="3">
<li>The function does the following:</li>
</ol>
<pre style="padding-left: 60px">model = Sequential()</pre>
<ol start="4">
<li>A sequential model is instantiated <span>–</span> a sequential model is an ANN model built using a linear stack of layers:</li>
</ol>
<pre style="padding-left: 60px">model.add(Dense(7, input_dim=7, kernel_initializer='normal', activation='sigmoid'))</pre>
<ol start="5">
<li>Here, we are adding a dense layer or fully-connected layer with seven neurons that are added to this sequential network. This layer accepts an input with <kbd>7</kbd> features (since there are seven input or features for predicting house price), which is indicated by the <kbd>input_dim</kbd> parameter. The weights of all the neurons in this layer are initialized using a random normal distribution, as indicated by the <kbd>kernel_initializer</kbd> parameter. Similarly, all the neurons of this layer use the sigmoid activation function, as indicated by the <kbd>activation</kbd> parameter:</li>
</ol>
<pre style="padding-left: 60px">model.add(Dense(1, kernel_initializer='normal'))</pre>
<ol start="6">
<li>Add another layer with a single neuron initialized using a random normal distribution:</li>
</ol>
<pre style="padding-left: 60px">sgd = optimizers.SGD(lr=0.01)</pre>
<ol start="7">
<li>Set the network to use <strong>Scalar Gradient Descent</strong> (<strong>SGD</strong>) to learn, usually specified as <kbd>optimizers</kbd>. We also indicate that the network will use a learning rate (<kbd>lr</kbd>) of <kbd>0.01</kbd> at every step of learning:</li>
</ol>
<pre style="padding-left: 60px">model.compile(loss='mean_squared_error', optimizer=sgd)</pre>
<ol start="8">
<li>Indicate that the network needs to use the <strong>mean squared error</strong> (<strong>MSE</strong>) cost function to measure the magnitude of the error rate of the model, and use the SGD optimizer to learn from the wrongness measured or loss of the model:</li>
</ol>
<pre style="padding-left: 60px">return model</pre>
<p style="padding-left: 60px">Finally, the function returns a model with the defined specifications. </p>
<p>The next step is to set a random seed for reproducibility; this random function is used to split the data into training and validation. The method used is k-fold validation, where the data is randomly divided into 10 subsets for training and validation:</p>
<pre>seed = 9 <br/>kfold = KFold(n_splits=10, random_state=seed)</pre>
<p>Now, we need to fit this model to predict a numerical value (house price, in this case), therefore we use <kbd>KerasRegressor</kbd>. <kbd>KerasRegressor</kbd> is a Keras wrapper used to access the regression estimators for the model from <kbd>sklearn</kbd>:</p>
<pre>estimator = KerasRegressor(build_fn=simple_shallow_seq_netl, epochs=100, batch_size=50, verbose=0)</pre>
<p>Note the following:</p>
<ul>
<li>We pass <kbd>simple_shallow_seq_net</kbd><strong> </strong>as a parameter to indicate the function that returns the model.</li>
<li>The <kbd>epochs</kbd> parameter indicates that every sample needs to go through the network at least <kbd>100</kbd> times.</li>
<li>The <kbd>batch_size</kbd> parameter indicates that during every learning cycle of the network there are <kbd>50</kbd> training samples used at a time.</li>
</ul>
<p>The next step is to train and cross-validate across the subsets of the data and print the MSE, which is the measure of how well the model performs:</p>
<pre>results = cross_val_score(estimator, features, target, cv=kfold) <br/>print("simple_shallow_seq_model:(%.2f) MSE" % (results.std()))<strong> </strong></pre>
<p>This will output the MSE <span>–</span> as you can see, it is pretty high and we need to make this value as low as possible:</p>
<pre>simple_shallow_seq_net:(163.41) MSE</pre>
<p>Save this model for later use:</p>
<pre>estimator.fit(features, target)<br/>estimator.model.save('simple_shallow_seq_net.h5')</pre>
<p>Great, we have built and saved our first neural net to predict real estate price. Our next efforts are to improve the neural net. The first thing to try before fiddling with the network parameters is to improve its performance (lower the MSE) when we standardize the data and use it:</p>
<pre>estimators = [] <br/>estimators.append(('standardize', StandardScaler())) <br/>estimators.append(('estimator', KerasRegressor(build_fn=simple_shallow_seq_net, epochs=100, batch_size=50, verbose=0))) <br/>pipeline = Pipeline(estimators)</pre>
<p>In the preceding code, we created a pipeline to standardize the data and then use it during every learning cycle of the network. In the following code block, we train and cross-evaluate the neural network:</p>
<pre>results = cross_val_score(pipeline, features, target, cv=kfold) <br/>print("simple_std_shallow_seq_net:(%.2f) MSE" % (results.std()))</pre>
<p>This will output a much better MSE than before, hence standardizing and using the data makes a difference:</p>
<pre>simple_std_shallow_seq_net:(65.55) MSE</pre>
<p>Saving this model is slightly different than before as we have used  <kbd>pipeline</kbd> to fit the model:</p>
<pre>pipeline.fit(features, target) <br/>pipeline.named_steps['estimator'].model.save('standardised_shallow_seq_net.h5')</pre>
<p>Let's now fiddle with our network to see whether we can get better results. We can start by creating a deeper network. We will increase the number of hidden or fully-connected layers and use both the <kbd>sigmoid</kbd> and <kbd>tanh</kbd> activation functions in alternate layers:</p>
<pre>def deep_seq_net(): <br/>    # create a deep sequential model <br/>    model = Sequential() <br/>    model.add(Dense(7, input_dim=7, kernel_initializer='normal', activation='sigmoid')) <br/>    model.add(Dense(7,activation='tanh')) <br/>    model.add(Dense(7,activation='sigmoid')) <br/>    model.add(Dense(7,activation='tanh')) <br/>    model.add(Dense(1, kernel_initializer='normal')) <br/>    sgd = optimizers.SGD(lr=0.01) <br/>    model.compile(loss='mean_squared_error', optimizer=sgd) <br/>    return model</pre>
<p class="mce-root"/>
<p>The next block of code is used to standardize<span> the variables in the training data and then fit the shallow neural net model to the training data. </span>Create the pipeline and fit the model using standardized data:</p>
<pre>estimators = [] <br/>estimators.append(('standardize', StandardScaler())) estimators.append(('estimator', KerasRegressor(build_fn=deep_seq_net, epochs=100, batch_size=50, verbose=0))) <br/>pipeline = Pipeline(estimators)</pre>
<p>Now, we need to cross-<span>validate the fit model </span>across the<span> subsets of the data and print the MSE:</span></p>
<pre>results = cross_val_score(pipeline, features, target, cv=kfold) <br/>print("simple_std_shallow_seq_net:(%.2f) MSE" % (results.std()))</pre>
<p>This will output an MSE that is better than the previous shallow networks that we created:</p>
<pre>deep_seq_net:(58.79) MSE</pre>
<p>Save the model for later use:</p>
<pre>pipeline.fit(features, target) <br/>pipeline.named_steps['estimator'].model.save('deep_seq_net.h5')<strong><br/></strong></pre>
<p>So, we get better results when we increase the depth (layers) of the network. Now, let's see what happens when we widen the network, that is, increase the number of neurons (nodes) in each layer. Let's define a deep and wide network to tackle the problem, we increase the neurons in each layer to <kbd>21</kbd>. Also, this time around, we will use the <kbd>relu</kbd> and <kbd>sigmoid</kbd> activation functions for the hidden layers:</p>
<pre class="mce-root">def deep_and_wide_net(): <br/>    # create a sequential model <br/>    model = Sequential() <br/>    model.add(Dense(21, input_dim=7, kernel_initializer='normal', activation='relu')) <br/>    model.add(Dense(21,activation='relu')) <br/>    model.add(Dense(21,activation='relu')) <br/>    model.add(Dense(21,activation='sigmoid')) <br/>    model.add(Dense(1, kernel_initializer='normal')) <br/>    sgd = optimizers.SGD(lr=0.01) <br/>    model.compile(loss='mean_squared_error', optimizer=sgd) <br/>    return model</pre>
<p>The next block of code is used to standardize the variables in the training data and then fit the deep and wide neural net model to the training data:</p>
<pre>estimators = [] <br/>estimators.append(('standardize', StandardScaler())) <br/>estimators.append(('estimator', KerasRegressor(build_fn=deep_and_wide_net, epochs=100, batch_size=50, verbose=0))) <br/>pipeline = Pipeline(estimators)</pre>
<p>Now, we need to cross-validate the fit model across the subsets of the data and print the MSE:</p>
<pre>results = cross_val_score(pipeline, features, target, cv=kfold) <br/>print("deep_and_wide_model:(%.2f) MSE" % (results.std()))</pre>
<p>This time, the MSE is again better than the previous networks we created. This is a good example of how a deeper network with more neurons abstracts the problem better:</p>
<pre>deep_and_wide_net:(34.43) MSE</pre>
<p>Finally, save the network for later use. The saved network model will be used in the next section and served within a REST API:</p>
<pre>pipeline.fit(features, target) <br/>pipeline.named_steps['estimator'].model.save('deep_and_wide_net.h5')</pre>
<p>So far, we have been able to build a sequential neural network for prediction using various network architectures. As an exercise, try the following:</p>
<ul>
<li>Experiment with the shape of the network; play around with the depth and width of the network to see how it impacts the output</li>
<li>Try out the various activation functions (<a href="https://keras.io/activations/">https://keras.io/activations/</a>)</li>
<li>Try out the various initializers, here we have only used the random normal initializer (<a href="https://keras.io/initializers/">https://keras.io/initializers/</a>)</li>
<li>The data we used here is for demonstrating the technique, so try out different use cases for prediction using the preceding technique on other datasets (<a href="https://data.world/datasets/prediction">https://data.world/datasets/prediction</a>)</li>
</ul>
<p>We will learn more about optimizers and regularizers, which are other parameters you can use to tune the network, in <a href="ed2667d7-0173-498a-ae53-1010580cf1de.xhtml" target="_blank">Chapter 4</a>, <em>Building a Machine Vision Mobile App to Classify Flower Species</em>. The complete code for our ANN model creation is available as a Python notebook named <kbd>sequence_networks_for_prediction.ipynb</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Serving the model as an API</h1>
                </header>
            
            <article>
                
<p>Now that we have created a model for prediction, the next thing is to serve this model via a RESTful API. To achieve this, we will use lightweight Python framework called Flask: <a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>.<a href="http://flask.pocoo.org/"/></p>
<p>Let's start by installing the <kbd>Flask</kbd> library in our conda environment if it does not already exist:</p>
<pre><strong>pip install Flask</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building a simple API to add two numbers</h1>
                </header>
            
            <article>
                
<p>Now we will build a very simple API to get a grip on the <kbd>Flask</kbd> library and framework. This API will accept a JSON object with two numbers and return the sum of the numbers as a response.</p>
<p>Open a new notebook from your Jupyter home page:</p>
<ol>
<li>Import all the libraries we need and create an app instance:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px">from flask import Flask, request <br/>app = Flask(__name__)</pre>
<ol start="2">
<li>Create the index page for the RESTful API using the <kbd>route()</kbd> decorator:</li>
</ol>
<pre style="padding-left: 60px">@app.route('/') <br/>def hello_world(): <br/> return 'This is the Index page'</pre>
<ol start="3">
<li>Create a <kbd>POST</kbd> API to add two numbers using the <kbd>route()</kbd> decorator. This API accepts a JSON object with the numbers to be added:</li>
</ol>
<pre style="padding-left: 60px">@app.route('/add', methods=['POST']) <br/>def add(): <br/>    req_data = request.get_json() <br/>    number_1 = req_data['number_1'] <br/>    number_2 = req_data['number_2'] <br/>    return str(int(number_1)+int(number_2))</pre>
<p>Save the Python notebook and use the <span class="packt_screen">File</span> menu to download the notebook as a Python file. Place the Python file in the same directory as the model file.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Start a new command terminal and traverse to the folder with this Python file and the model. Make sure to activate the conda environment and run the following to start a server running the simple API:</p>
<ul>
<li>If you are using Windows, enter the following:</li>
</ul>
<pre style="padding-left: 60px"><strong>set FLASK_APP=simple_api</strong></pre>
<ul>
<li>If you aren't using Windows, enter this:</li>
</ul>
<pre style="padding-left: 60px"><strong>export FLASK_APP=simple_api</strong></pre>
<p style="padding-left: 60px">Then type the following:</p>
<pre style="padding-left: 60px"><strong>flask run</strong></pre>
<p style="padding-left: 60px">You should see the following output when the server starts:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/77ddebb5-0ed8-49cd-8ae8-66da25492323.jpg"/></p>
<p>Open the browser and paste this address in the URL bar to go to the index page: <kbd>http://127.0.0.1:5000/</kbd>. Here is the output:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-862 image-border" src="assets/43df027c-5e68-4e2e-aa8e-5c3233c7e2be.png" style="width:22.75em;height:8.50em;"/></p>
<p>Next, we will use <kbd>curl</kbd> to access the <kbd>POST</kbd> API that adds two numbers. Open a new terminal and enter the following curl command to test the <kbd>/add</kbd> API. The numbers to add in this example are <kbd>1</kbd> and <kbd>2</kbd>, and this is passed as a JSON object:</p>
<pre><strong>curl -i -X POST -H "Content-Type: application/json" -d "{\"number_1\":\"1\",\"number_2\":\"2\"}" http://127.0.0.1:5000/add</strong></pre>
<p>We will get a response with the sum of the numbers if there are no errors:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-863 image-border" src="assets/cec53b9e-bbf0-43d0-b2ad-18bfda3a0dab.png" style="width:91.67em;height:19.25em;"/></p>
<p>The complete code for the simple API is available as a Python notebook named <kbd>simple_api.ipynb</kbd> and as a Python file named <kbd>simple_api.py</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building an API to predict the real estate price using the saved model</h1>
                </header>
            
            <article>
                
<p>Now that we have seen how  <kbd>Flask</kbd> works, we need to implement an API to serve the model we built previously. Start a new Jupyter Notebook and follow these steps:</p>
<ol>
<li>Import the required Python modules and create a Flask app instance:</li>
</ol>
<pre style="padding-left: 60px">from flask import Flask, request <br/>from keras.models import load_model<br/>from keras import backend as K<br/><br/>import numpy <br/>app = Flask(__name__)</pre>
<ol start="2">
<li>Create <kbd>Index page</kbd> for the RESTful API using the <kbd>route()</kbd> decorator:</li>
</ol>
<pre style="padding-left: 60px">@app.route('/') <br/>def hello_world(): <br/>    return 'Index page'</pre>
<ol start="3">
<li>Create a <kbd>POST</kbd> API to predict house price using the <kbd>route()</kbd> decorator. This accepts a JSON object with all the features required to predict the house or real estate price:</li>
</ol>
<pre style="padding-left: 60px">@app.route('/predict', methods=['POST']) <br/>def add(): <br/>    req_data = request.get_json() <br/>     bizprop = req_data['bizprop'] <br/>    rooms = req_data['rooms'] <br/>    age = req_data['age'] <br/>    highways = req_data['highways'] <br/>    tax = req_data['tax'] <br/>    ptratio = req_data['ptratio'] <br/>    lstat = req_data['lstat'] <br/>    # This is where we load the actual saved model into new variable. <br/>    deep_and_wide_net = load_model('deep_and_wide_net.h5') <br/>    # Now we can use this to predict on new data <br/>    value = deep_and_wide_net.predict_on_batch(numpy.array([[bizprop, rooms, age  ,  highways   , tax   ,  ptratio  ,   lstat]], dtype=float)) <br/>    K.clear_session()<br/><br/>    return str(value)<strong><br/></strong></pre>
<p>Save the Python notebook and use the <span class="packt_screen">File</span> menu to download the notebook as a Python file. Place the Python file in the same directory as the model file.</p>
<p>Start a new command terminal and traverse to the folder with this Python file and the model. Make sure to activate the conda environment and run the following to start a server that runs the simple API:</p>
<ul>
<li>If you are using Windows, enter the following:</li>
</ul>
<pre style="padding-left: 60px"><strong>set FLASK_APP=predict_api</strong></pre>
<ul>
<li>If you aren't using Windows, use this:</li>
</ul>
<pre style="padding-left: 60px"><strong>export FLASK_APP= predict_api</strong></pre>
<p style="padding-left: 60px">Then type the following:</p>
<pre style="padding-left: 60px"><strong>flask run</strong></pre>
<p>Next, we will use <kbd>curl</kbd> to access the <kbd>POST</kbd> API that predicts house prices. Open a new terminal and enter the following <kbd>curl</kbd> command to test the <kbd>/predict</kbd> API. We can pass the features to be used as input for the model as a JSON object:</p>
<pre><strong>curl -i -X POST -H "Content-Type: application/json" -d "{\"bizprop\":\"1\",\"rooms\":\"2\",\"age\":\"1\",\"highways\":\"1\",\"tax\":\"1\",\"ptratio\":\"1\",\"lstat\":\"1\"}" http://127.0.0.1:5000/predict</strong></pre>
<p>This will output the house price for the features provided using our prediction model:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/19cdc927-bbf0-4479-b019-3ee9ddec2f73.jpg"/></p>
<p>That's it! We just built an API to serve our prediction model and tested it using <kbd>curl</kbd>. The complete code for the prediction API is available as a Python notebook named <kbd>predict_api.ipynb</kbd> and as a Python file named <kbd>simple_api.py</kbd>.</p>
<p>Next, we are going to see how to make a mobile app that will use the API that hosts our model. We will start by creating an Android app that uses the prediction API and then repeat the same task on an iOS app.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an Android app to predict house prices</h1>
                </header>
            
            <article>
                
<p>In this section, we are going to consume the model through the RESTful API via an Android app. The purpose of this section is to demonstrate how a model can be consumed and used by an Android app. Here, we have assumed that you are familiar with the basics of Java programming. The same approach can be used for any similar use case, even on web apps. The following steps are covered in this section:</p>
<ul>
<li>Downloading and installing Android Studio</li>
<li>Creating a new Android project with a single screen</li>
<li>Designing the layout of the screen</li>
<li>Adding a functionality to accept input</li>
<li>Adding a functionality to consume the RESTful API that serves the model</li>
<li>Additional notes</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Downloading and installing Android Studio</h1>
                </header>
            
            <article>
                
<p>Android Studio is the development environment and sandbox for Android app development. All our Android projects will be made using Android Studio. We can use Android Studio to create, design, and test our apps before publishing them. </p>
<p>Head over to the official Android Studio download page, <a href="https://developer.android.com/studio/">https://developer.android.com/studio/</a>, and choose the version that matches your OS. In this case, we are using a Windows executable:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-865 image-border" src="assets/16d203e0-62e1-4319-87dd-91084a31fc4c.png" style="width:49.50em;height:20.08em;"/></p>
<p>Run the executable once it is downloaded to start the installation process. You will be presented with progressive installation menu choices. C<span>hoose <span class="packt_screen">Next</span> and progress through the installation process. M</span>ost of the options are chosen as default during the installation steps. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a new Android project with a single screen</h1>
                </header>
            
            <article>
                
<p>Now that we have installed Android Studio, we will create a simple app to estimate the price of real estate based on certain input.</p>
<p class="mce-root"/>
<p>Once we start Android Studio, it gives us a menu to start creating projects. Click on the <span class="packt_screen">Start a new Android Studio project</span> option:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-935 image-border" src="assets/4131112d-51a2-4203-a771-42bd378e4f3d.png" style="width:43.67em;height:33.42em;"/></p>
<p>The next dialog is to select the <span class="packt_screen">Application name</span> and <span class="packt_screen">Project location</span>. Choose whatever you want and click <span class="packt_screen">Next</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d9aae155-2d19-4601-878a-fd8008993202.png" style="width:50.17em;height:38.42em;"/></p>
<p>Next, choose the target versions for the application to run on:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1ba1f6d5-aa22-4139-b019-a890b09584de.png" style="width:49.25em;height:37.83em;"/></p>
<p>Then choose a screen for the app; in this case, select an <span class="packt_screen">Empty Activity</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/88b0a687-fec0-4f7f-af95-54a2a79ccb4e.png" style="width:47.83em;height:36.50em;"/></p>
<p>Choose the screen or <span class="packt_screen">Activity Name</span> and the corresponding name for the layout or design of the activity screen:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-867 image-border" src="assets/80508382-73a6-420d-b677-60fe007b8dc0.png" style="width:47.58em;height:32.75em;"/></p>
<p class="mce-root"/>
<p>The project should load in a few seconds after the build is complete. In the project structure, there are three main folders:</p>
<ul>
<li><span class="packt_screen">manifests</span>: This folder contains the manifest file used for permissions and application versioning.</li>
<li><span class="packt_screen">java</span>: This folder has all the Java code files (<span class="packt_screen">java</span>|<span class="packt_screen">app</span>|<span class="packt_screen">chapter2</span>|<span class="packt_screen">realestateprediction</span>|<span class="packt_screen">MainActivity.java</span>).</li>
<li><span class="packt_screen">res</span>: This folder has all the layout files and media files used in the application (<span class="packt_screen">res</span>|<span class="packt_screen">layout</span>|<span class="packt_screen">activity_main.xml</span>):</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-868 image-border" src="assets/5821d790-164b-41e5-81d8-0e771d0a4d36.png" style="width:130.33em;height:47.17em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Designing the layout of the screen</h1>
                </header>
            
            <article>
                
<p>Let's design the screen that will accept the factors of the model we created as input. The screen will have seven input boxes to accept the factors, one button, and an output textbox to display the predicted result:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0b6aa2a2-7cdf-432b-b49c-5a1a058e6afd.jpg" style="width:29.75em;height:49.08em;"/></p>
<p>Traverse to the<strong> </strong><span class="packt_screen">layout</span> folder in <span class="packt_screen">res</span> and select the <span class="packt_screen">activity_layout.xml</span> file to open in the editing panel. Choose the <span class="packt_screen">Text</span> option at the bottom to view the existing XML for the layout:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-869 image-border" src="assets/073f2eb7-11ec-4426-899a-2693b6247880.png" style="width:53.00em;height:30.67em;"/></p>
<p>Now, replace the existing XML code with the new design template for the app. Please refer to the <span class="packt_screen">activity_layout.xml</span><span> </span>code file in the <span class="packt_screen">Android</span> folder for the full design template. The following is only a skeletal reference of the XML code template:</p>
<pre class="mce-root"><em>&lt;?</em>xml version="1.0" encoding="utf-8"<em>?&gt;<br/> </em>&lt;ScrollView <br/>     android:layout_width="match_parent"<br/>     android:layout_height="match_parent"<br/>     android:fillViewport="true"&gt;   <br/>     &lt;RelativeLayout<br/>         android:layout_width="match_parent"<br/>         android:layout_height="match_parent"<br/>         &gt; <br/>         &lt;TextView<br/>             android:id="@+id/bizprop"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/bizprop-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/rooms"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/rooms-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/age"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/age-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/highways"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/highways-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/tax"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/tax-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/ptratio"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/ptratio-edit"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/lstat"/&gt;<br/>         &lt;EditText<br/>             android:id="@+id/lstat-edit"/&gt;<br/>         &lt;Button<br/>             android:id="@+id/button"/&gt;<br/>         &lt;TextView<br/>             android:id="@+id/value"/&gt;<br/>     &lt;/RelativeLayout&gt;<br/> &lt;/ScrollView&gt;</pre>
<p>Here, we have designed a layout to accept the seven factors as input, as follows:</p>
<ul>
<li><span class="packt_screen"><span class="packt_screen">BIZPROP</span></span>: Proportion of non-retail business acres per town</li>
<li><span class="packt_screen">ROOMS</span>: Average number of rooms per dwelling</li>
<li><span class="packt_screen"><strong>A</strong><span class="packt_screen"><strong>GE</strong></span></span>: Proportion of owner-occupied units built prior to 1940</li>
<li><span class="packt_screen"><strong>HIGHWAYS</strong></span>: Index of accessibility to radial highways</li>
<li><span class="packt_screen"><strong>TAX</strong></span>: Full-value property-tax rate per $10,000</li>
</ul>
<ul>
<li><span class="packt_screen"><strong>PTRATIO</strong></span>: Pupil-to-teacher ratio by town</li>
<li><span class="packt_screen"><strong>LSTAT</strong></span>: Percentage of lower status of the population</li>
</ul>
<p>There is also a button and a textbox to display the output. The predicted value is displayed when the button is clicked.</p>
<p>To view the design of the activity, run the <span class="packt_screen">Run app</span> option in the <strong><span class="packt_screen">run</span></strong> menu from the top menu bar. The first time you run it, the environment will ask you to create a virtual device to test your app. You can either create an <strong>Android Virtual Device</strong><span> (</span><strong>AVD</strong><span>) or use the traditional method, that is, use an USB cable to connect your Android phone to the PC so that you can run the output directly on your device:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e518d696-637a-457a-be1a-121b5203a0f1.png" style="width:38.08em;height:30.83em;"/></p>
<p>You should see the design of the scrollable layout once the app starts on the device or AVD emulator:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1c8e556b-4586-4f6b-9e1e-cea5afd364c7.png"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a functionality to accept input</h1>
                </header>
            
            <article>
                
<p>Now we need to accept the input and create a map to hold the values. We will then convert the map into a JSON object so that it can be passed as the data in the <kbd>POST</kbd> API request.</p>
<p>Traverse to the <kbd>MainActivity.java</kbd> file and open it in the edit panel of Android Studio. Declare the following class variables:</p>
<pre><strong> private </strong>EditText <strong>bizprop</strong>, <strong>rooms</strong>, <strong>age</strong>, <strong>highways</strong>, <strong>tax</strong>, <strong>ptratio</strong>, <strong>lstat</strong>;<br/> <strong>private </strong>Button <strong>estimate</strong>;<br/> <strong>private </strong>TextView <strong>value</strong>;</pre>
<p>You will find a function called <kbd>onCreate()</kbd> that is already created. Add the following code into the <kbd>onCreate()</kbd> function to initialize the elements of the layout:</p>
<pre><strong> bizprop </strong>= (EditText) findViewById(R.id.<strong><em>bizprop_edit</em></strong>);<br/> <strong>rooms </strong>= (EditText) findViewById(R.id.<strong><em>rooms_edit</em></strong>);<br/> <strong>age </strong>= (EditText) findViewById(R.id.<strong><em>age_edit</em></strong>);<br/> <strong>highways </strong>= (EditText) findViewById(R.id.<strong><em>highways_edit</em></strong>);<br/> <strong>tax </strong>= (EditText) findViewById(R.id.<strong><em>tax_edit</em></strong>);<br/> <strong>ptratio </strong>= (EditText) findViewById(R.id.<strong><em>ptratio_edit</em></strong>);<br/> <strong>lstat </strong>= (EditText) findViewById(R.id.<strong><em>lstat_edit</em></strong>);<br/> <strong>value </strong>=  (TextView) findViewById(R.id.<strong><em>value</em></strong>);<br/> <strong>estimate </strong>= (Button) findViewById(R.id.<strong><em>button</em></strong>);</pre>
<p>Now add another function called <kbd>makeJSON()</kbd> to the Java class. This function accepts the values from the edit boxes and returns the JSON object we need to pass as data in our API call:</p>
<pre><strong>public </strong>JSONObject makeJSON() {<br/> <br/>     JSONObject jObj = <strong>new </strong>JSONObject();<br/>     <strong>try </strong>{<br/> <br/>         jObj.put(<strong>"bizprop"</strong>, <strong>bizprop</strong>.getText().toString());<br/>         jObj.put(<strong>"rooms"</strong>,  <strong>rooms</strong>.getText().toString());<br/>         jObj.put(<strong>"age"</strong>,  <strong>age</strong>.getText().toString());<br/>         jObj.put(<strong>"tax"</strong>,  <strong>tax</strong>.getText().toString() );<br/>         jObj.put(<strong>"highways"</strong>,  <strong>highways</strong>.getText().toString());<br/>         jObj.put(<strong>"ptratio"</strong>,  <strong>ptratio</strong>.getText().toString());<br/>         jObj.put(<strong>"lstat"</strong>, <strong>lstat</strong>.getText().toString());<br/>         <br/>     } <strong>catch </strong>(Exception e) {<br/>         System.<strong><em>out</em></strong>.println(<strong>"Error:" </strong>+ e);<br/>     }<br/> <br/>     Log.<em>i</em>(<strong>""</strong>, jObj.toString());<br/> <br/>     <strong>return </strong>jObj;<br/> }</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a functionality to consume the RESTful API that serves the model</h1>
                </header>
            
            <article>
                
<p>Now we need to hit the API with the data on a click of the button. To achieve this, we need the flowing helper functions:</p>
<ul>
<li><kbd>ByPostMethod</kbd>: Accepts the URL as a <kbd>String</kbd> and returns the response as an <kbd>InputStream</kbd>.  This function takes the server URL string that we created using the Flask framework and returns the response from the server as an input stream:</li>
</ul>
<pre style="padding-left: 60px">InputStream ByPostMethod(String ServerURL) {<br/> <br/>     InputStream DataInputStream = <strong>null</strong>;<br/>     <strong>try </strong>{<br/>         URL url = <strong>new </strong>URL(ServerURL);<br/> <br/>         HttpURLConnection connection = (HttpURLConnection)<br/>         url.openConnection();<br/>         connection.setDoOutput(<strong>true</strong>);<br/>         connection.setDoInput(<strong>true</strong>);<br/>         connection.setInstanceFollowRedirects(<strong>false</strong>);<br/>         connection.setRequestMethod(<strong>"POST"</strong>);<br/>         connection.setRequestProperty(<strong>"Content-Type"</strong>, <strong>"application/json"</strong>);<br/>         connection.setRequestProperty(<strong>"charset"</strong>, <strong>"utf-8"</strong>);<br/>         connection.setUseCaches (<strong>false</strong>);<br/>         DataOutputStream dos = <strong>new </strong>DataOutputStream(connection.getOutputStream());<br/>         dos.writeBytes(makeJSON().toString());<br/>         <em>//flushes data output stream.<br/>         </em>dos.flush();<br/>         dos.close();<br/>         <em>//Getting HTTP response code<br/>         </em><strong>int </strong>response = connection.getResponseCode();<br/>         <em>//if response code is 200 / OK then read Inputstream<br/>         //HttpURLConnection.HTTP_OK is equal to 200<br/>         </em><strong>if</strong>(response == HttpURLConnection.<strong><em>HTTP_OK</em></strong>) {<br/>             DataInputStream = connection.getInputStream();<br/>         }<br/> <br/>     } <strong>catch </strong>(Exception e) {<br/>         Log.<em>e</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"Error in GetData"</strong>, e);<br/>     }<br/>     <strong>return </strong>DataInputStream;<br/> <br/> }</pre>
<ul>
<li><kbd>ConvertStreamToString</kbd>: This function accepts <kbd>InputStream</kbd> and returns a <kbd>String</kbd> of the response. The input stream returned from the previous function is processed as a string object by the following function:</li>
</ul>
<pre style="padding-left: 60px">String ConvertStreamToString(InputStream stream) {<br/> <br/>     InputStreamReader isr = <strong>new </strong>InputStreamReader(stream);<br/>     BufferedReader reader = <strong>new </strong>BufferedReader(isr);<br/>     StringBuilder response = <strong>new </strong>StringBuilder();<br/> <br/>     String line = <strong>null</strong>;<br/>     <strong>try </strong>{<br/> <br/>         <strong>while </strong>((line = reader.readLine()) != <strong>null</strong>) {<br/>             response.append(line);<br/>         }<br/> <br/>     } <strong>catch </strong>(IOException e) {<br/>         Log.<em>e</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"Error in ConvertStreamToString"</strong>, e);<br/>     } <strong>catch </strong>(Exception e) {<br/>         Log.<em>e</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"Error in ConvertStreamToString"</strong>, e);<br/>     } <strong>finally </strong>{<br/> <br/>         <strong>try </strong>{<br/>             stream.close();<br/> <br/>         } <strong>catch </strong>(IOException e) {<br/>             Log.<em>e</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"Error in ConvertStreamToString"</strong>, e);<br/> <br/>         } <strong>catch </strong>(Exception e) {<br/>             Log.<em>e</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"Error in ConvertStreamToString"</strong>, e);<br/>         }<br/>     }<br/>     <strong>return </strong>response.toString();<br/> }</pre>
<ul>
<li><kbd>DisplayMessage</kbd>: This functions updates the textbox with the response, which is the predicted value:</li>
</ul>
<pre style="padding-left: 60px"><strong>public void </strong>DisplayMessage(String a) <br/>{<br/>     <br/>     <strong>value</strong>.setText(a);<br/> }</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>A point to note is that whenever network calls are made on Android, it is a best practice to do it on a separate thread so it does not block the main <strong>user interface</strong> (<strong>UI</strong>) thread. So, we will write an inner class called <kbd>MakeNetworkCall</kbd> to achieve this:</p>
<pre><strong>private class </strong>MakeNetworkCall <strong>extends </strong>AsyncTask&lt;String, Void, String&gt; {<br/> <br/>     @Override<br/>     <strong>protected void </strong>onPreExecute() {<br/>         <strong>super</strong>.onPreExecute();<br/>         DisplayMessage(<strong>"Please Wait ..."</strong>);<br/>     }<br/> <br/>     @Override<br/>     <strong>protected </strong>String doInBackground(String... arg) {<br/> <br/>         InputStream is = <strong>null</strong>;<br/>         String URL = <strong>"http://10.0.2.2:5000/predict"</strong>;<br/>         Log.<em>d</em>(<strong>"ERROR CAUGHT"</strong>, <strong>"URL: " </strong>+ URL);<br/>         String res = <strong>""</strong>;<br/> <br/>         is = ByPostMethod(URL);<br/> <br/>         <strong>if </strong>(is != <strong>null</strong>) {<br/>             res = ConvertStreamToString(is);<br/>         } <strong>else </strong>{<br/>             res = <strong>"Something went wrong"</strong>;<br/>         }<br/>         <strong>return </strong>res;<br/>     }<br/> <br/>     <strong>protected void </strong>onPostExecute(String result) {<br/>         <strong>super</strong>.onPostExecute(result);<br/> <br/>         DisplayMessage(result);<br/>         Log.<em>d</em>(<strong>"COMPLETED"</strong>, <strong>"Result: " </strong>+ result);<br/>     }<br/> }</pre>
<p>Please note that we used <kbd>http://10.0.2.2:5000/predict</kbd> instead of <kbd>http://127.0.0.1:5000/predict</kbd>. This is done because in Android, when we use the emulator, it accesses the local host via <kbd>10.0.2.2</kbd> instead of <kbd>127.0.0.1</kbd>. As the example is run on an emulator, we used <kbd>10.0.2.2</kbd>.</p>
<p>Finally, we need to add the functionality to call the API on click of the button. So, within the <kbd>oncreate()</kbd> method, insert the following code after the button has been initialized. This will initiate a background thread to access the API on a click of the button:</p>
<pre><strong>estimate</strong>.setOnClickListener(<strong>new </strong>View.OnClickListener() {<br/>     @Override<br/>     <strong>public void </strong>onClick(View v) {<br/>         Log.<em>i</em>(<strong>"CHECK"</strong>, <strong>"CLICKED"</strong>);<br/> <br/>         <strong>new </strong>MakeNetworkCall().execute(<strong>"http://10.0.2.2:5000/predict"</strong>, <strong>"Post"</strong>);<br/>     }<br/> });</pre>
<p>We need to add permissions to use internet within the <kbd>AndroidManifest.xml</kbd> file. Place the following code inside the <kbd>&lt;manifest&gt;</kbd> tag:</p>
<pre>&lt;<strong>uses-permission android:name="android.permission.INTERNET"</strong>&gt;&lt;/<strong>uses-permission</strong>&gt;</pre>
<p>Don't forget to run your Flask app. If you haven't already, make sure to run it within the conda environment activated:</p>
<pre><strong>set FLASK_APP=predict_api</strong><br/><br/><strong>flask run</strong></pre>
<p>That is all the code required to run and test the app on Android. Now run the app in the emulator, enter the details on the screen, hit the <span class="packt_screen">ESTIMATE VALUE</span> button, and you'll get immediate results:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fe3b6dbc-7420-4f10-9f37-995f866d0c02.png" style="width:28.33em;height:45.00em;"/></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Additional notes</h1>
                </header>
            
            <article>
                
<p>This was a demonstration of how we can use the AI models built on an Android device. Having said that, there are a lot of additional tasks that can be added to the existing app:</p>
<ul>
<li>Improve the UI design</li>
<li>Add input checks to validate the data entered</li>
<li>Host the Flask app (Heroku, AWS, and more)</li>
<li>Publish the app</li>
</ul>
<p>All these tasks are independent of our core AI theme, so can be addressed as an exercise for the reader.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an iOS app to predict house prices</h1>
                </header>
            
            <article>
                
<p>In this section, we are going to consume the model through the RESTful API via an iOS app. The purpose of this section is to demonstrate how a model can be consumed and used by an iOS app. <span>Here, we have assumed that you are familiar with Swift programming. </span>The same approach can be used for any similar use case. These are the following steps covered in this section:</p>
<ul>
<li><span>Downloading and installing Xcode</span></li>
<li>Creating a new iOS project with a single screen</li>
<li>Designing the layout of the screen</li>
<li>Adding a functionality to accept input</li>
<li>Adding a functionality to consume the RESTful API that serves the model</li>
<li>Additional notes</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Downloading and installing Xcode</h1>
                </header>
            
            <article>
                
<p>You need a Mac (<span>macOS 10.11.5 or later)</span> to develop the iOS apps that are implemented in this book. Also, the latest version of Xcode is required to run those codes since it contains all the features that are necessary to design, develop, and debug any app. </p>
<p>To download the latest version of Xcode, follow these steps:</p>
<ol>
<li>Open the App Store on your Mac (it's in the Dock by default).</li>
<li>Type <kbd>Xcode</kbd> in <span>the search field, which is at the top-right corner. Then </span>press the return key.</li>
</ol>
<ol start="3">
<li>The first search result that turns up is the Xcode app.</li>
<li>Click on <span class="packt_screen">Get</span> and then click on <span class="packt_screen">Install App</span>.</li>
<li>Enter your Apple ID and password.</li>
<li>Xcode will be downloaded in your <kbd>/Applications</kbd> directory.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a new iOS project with a single screen</h1>
                </header>
            
            <article>
                
<p>Xcode includes several built-in app templates. We will start with a basic template: Single View Application. Open Xcode from the <kbd>/Applications</kbd> directory to create a new project.</p>
<p>If you are launching Xcode for the first time, it may ask you to agree to all the user agreements. Proceed by clicking on these prompts until Xcode is set up and ready to launch on your system.</p>
<p>Once we launch Xcode, the following window appears:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-870 image-border" src="assets/7a6aa306-1b07-4f5a-a055-31e05a850377.png" style="width:49.42em;height:30.83em;"/></p>
<p>Click on <span class="packt_screen">Create a new Xcode project</span>. A new window will open that displays a dialog box that allows us to select the required template:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/dbdc672b-af4c-4db8-b9b2-fba77d240fea.png" style="width:50.00em;height:35.75em;"/></p>
<p class="mce-root"/>
<p>After we select a template, a dialog box appears. Here, you need to name your app for which you can use the following values. You can also choose some additional options for your project:</p>
<ul>
<li><strong>Product Name</strong>: Xcode will use the product name that you entered to name both the project and the app.</li>
<li><strong>Team</strong>: If there's no value filled in, set the team to <span class="packt_screen">None</span>.</li>
<li><strong>Organization Name</strong>: This is an optional field. You can either enter your organization's name or your name. You may also choose to leave this option blank.</li>
<li><strong>Organization Identifier</strong>: If you have an organization identifier, use that value. If you don't, use <kbd>com.example</kbd>.</li>
<li><strong>Bundle Identifier</strong>: This value is automatically generated based on your product name and organization identifier.</li>
<li><strong>Language</strong>: <span class="packt_screen">Swift</span>.</li>
<li><strong>Devices</strong>: <span class="packt_screen">Universal</span>. An app that runs on both iPhones and iPads is considered a universal app.</li>
<li><strong>Use Core Data</strong>: We don't need any core date. Hence, it remains unselected.</li>
<li><strong>Include Unit Tests</strong>: We need to include unit tests. So this option will be selected.</li>
<li><strong>Include UI Tests</strong>: We don't need to include any  UI tests. Hence, this option stays unselected.</li>
</ul>
<p>Now, click on <span class="packt_screen">Next</span>. A dialog box will appear, where you need to select a location to save your project. After saving the project, click on <span class="packt_screen">Create</span>. You new project will be opened by Xcode in the workspace window.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Designing the layout of the screen</h1>
                </header>
            
            <article>
                
<p>Let's design the screen that will accept the factors of the model we created as input. The screen will have seven input boxes to accept the factors, one button, and an output textbox to display the predicted result:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/589a76d7-b37b-4dc7-9362-302898467a83.jpg" style="width:30.75em;height:50.83em;"/></p>
<p>Let's work on the storyboard that is required for the app. What is a storyboard? A storyboard displays the screen of content and the transitions between that content. It gives us a visual representation of the application's UI. <span>We get a </span><strong>WYSIWYG</strong><span> (short for </span><strong>what you see is what you get</strong><span>) editor where we can see the changes in real-time.</span></p>
<p class="mce-root"/>
<p>To open the storyboard, select the <span class="packt_screen">Main.storyboard</span> option in the project navigator<span>.</span> This will open a canvas where we can design the screen. We can now add elements and design the canvas:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/675b1bb5-e59c-4d18-a961-81fc301bccbf.png"/></p>
<p>The same can also be coded instead of using the drag-and-drop approach. To do so, start by defining the text fields that are used as input in the <kbd>ViewController</kbd> class:</p>
<pre>@interface ViewController ()&lt;UITextFieldDelegate&gt;<br/>{<br/> UITextField* bizropfeild,*roomsfeild,*agefeild,*highwaysfeild,*taxfeild,*ptratiofeild,*lstatfeild;<br/>}<br/>@end</pre>
<p>Then, within the <kbd>CreateView</kbd> method, we implement the design of each text field. The following is the sample for the first couple of text fields; the same approach can be used for the rest of the text fields. The completed project code is available in the <kbd>chapter2_ios_prediction</kbd> folder.</p>
<p>First, create a header text field, <kbd>Estimate the value of real estate</kbd>:</p>
<pre>UILabel *headerLabel = [[UILabel alloc]initWithFrame:CGRectMake(10, 20, self.view.frame.size.width-20, 25)];<br/> headerLabel.font = [UIFont fontWithName:@"SnellRoundhand-Black" size:20]; //custom font<br/> headerLabel.backgroundColor = [UIColor clearColor];<br/> headerLabel.textColor = [UIColor blackColor];<br/> headerLabel.textAlignment = NSTextAlignmentCenter;<br/> headerLabel.text=@"Estimate the value of real estate";<br/> [self.view addSubview:headerLabel];<br/> <br/> <br/> UIView *sepratorLine =[[UIView alloc]initWithFrame:CGRectMake(0, 50, self.view.frame.size.width, 5)];<br/> sepratorLine.backgroundColor=[UIColor blackColor];<br/> [self.view addSubview:sepratorLine];</pre>
<p>Next, create <span>another </span>text field, <kbd>Enter real estate details</kbd>:</p>
<pre>UILabel *detailLabel = [[UILabel alloc]initWithFrame:CGRectMake(10, 55, self.view.frame.size.width-20, 25)];<br/> detailLabel.font = [UIFont fontWithName:@"SnellRoundhand-Black" size:18]; //custom font<br/> detailLabel.backgroundColor = [UIColor clearColor];<br/> detailLabel.textColor = [UIColor blackColor];<br/> detailLabel.textAlignment = NSTextAlignmentLeft;<br/> detailLabel.text=@"Enter real estate details";<br/> [self.view addSubview:detailLabel];</pre>
<p>Next, create a field to enter the input for a proportion of non-retail business in acres:</p>
<pre> UILabel *bizropLabel = [[UILabel alloc]initWithFrame:CGRectMake(5, 85, self.view.frame.size.width-150, 35)];<br/> bizropLabel.font = [UIFont fontWithName:@"TimesNewRomanPSMT" size:12]; //custom font<br/> bizropLabel.backgroundColor = [UIColor clearColor];<br/> bizropLabel.numberOfLines=2;<br/> bizropLabel.textColor = [UIColor blackColor];<br/> bizropLabel.textAlignment = NSTextAlignmentLeft;<br/> bizropLabel.text=@"Bizrope, The proportion of non-retail business acres per town";<br/> [self.view addSubview:bizropLabel];<br/> <br/> bizropfeild = [[UITextField alloc] initWithFrame:CGRectMake(self.view.frame.size.width-140, 85, 130, 35)];<br/> bizropfeild.delegate=self;<br/> bizropfeild.layer.borderColor=[UIColor blackColor].CGColor;<br/> bizropfeild.layer.borderWidth=1.0;<br/> [self.view addSubview:bizropfeild];<br/> </pre>
<p>Now create a field to enter the input for the average number of rooms per dwelling:</p>
<pre>UILabel *roomsLabel = [[UILabel alloc]initWithFrame:CGRectMake(5, 125, self.view.frame.size.width-150, 35)];<br/> roomsLabel.font = [UIFont fontWithName:@"TimesNewRomanPSMT" size:12]; //custom font<br/> roomsLabel.backgroundColor = [UIColor clearColor];<br/> roomsLabel.numberOfLines=2;<br/> roomsLabel.textColor = [UIColor blackColor];<br/> roomsLabel.textAlignment = NSTextAlignmentLeft;<br/> roomsLabel.text=@"ROOMS, the average number of rooms per dwelling";<br/> [self.view addSubview:roomsLabel];<br/> <br/> roomsfeild = [[UITextField alloc] initWithFrame:CGRectMake(self.view.frame.size.width-140, 125, 130, 35)];<br/> roomsfeild.delegate=self;<br/> roomsfeild.layer.borderColor=[UIColor blackColor].CGColor;<br/> roomsfeild.layer.borderWidth=1.0;<br/> [self.view addSubview:roomsfeild];</pre>
<p class="mce-root">Then, create a button to hit the API:</p>
<pre class="mce-root">UIButton *estimateButton = [UIButton buttonWithType:UIButtonTypeRoundedRect];<br/> [estimateButton addTarget:self action:@selector(estimateAction)<br/> forControlEvents:UIControlEventTouchUpInside];<br/> estimateButton.layer.borderColor=[UIColor blackColor].CGColor;<br/> estimateButton.layer.borderWidth=1.0;<br/> [estimateButton setTitle:@"Estimate" forState:UIControlStateNormal];<br/> [estimateButton setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];<br/> estimateButton.frame = CGRectMake(self.view.frame.size.width/2-80, 375, 160.0, 40.0);<br/> [self.view addSubview:estimateButton];</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a functionality to accept input</h1>
                </header>
            
            <article>
                
<p>Here, all the input from the text fields are packaged in an <kbd>NSString</kbd> object, which is used in the <kbd>POST</kbd> body of the request:</p>
<pre>NSString *userUpdate =[NSString stringWithFormat:@"bizprop=%@&amp;rooms=%@&amp;age=%@&amp;highways=%@&amp;tax=%@&amp;ptratio=%@&amp;lstat=%@",bizropfeild.text,roomsfeild.text,agefeild.text,highwaysfeild.text,taxfeild.text,ptratiofeild.text,lstatfeild.text];</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a functionality to consume the RESTful API that serves the model</h1>
                </header>
            
            <article>
                
<p>Now we need to use the <kbd>NSURLSession</kbd> object to hit the RESTful API with the input from the activity screen:</p>
<pre>//create the Method "GET" or "POST"<br/> [urlRequest setHTTPMethod:@"POST"];<br/> //Convert the String to Data<br/> NSData *data1 = [userUpdate dataUsingEncoding:NSUTF8StringEncoding];<br/> //Apply the data to the body<br/> [urlRequest setHTTPBody:data1];<br/> NSURLSession *session = [NSURLSession sharedSession];<br/> NSURLSessionDataTask *dataTask = [session dataTaskWithRequest:urlRequest completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) { }</pre>
<p>Finally, display the output from the response received from the API:</p>
<pre>NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *)response;<br/> if(httpResponse.statusCode == 200)<br/> {<br/> NSError *parseError = nil;<br/> NSDictionary *responseDictionary = [NSJSONSerialization JSONObjectWithData:data options:0 error:&amp;parseError];<br/> NSLog(@"The response is - %@",responseDictionary);<br/>UILabel *outputLabel = [[UILabel alloc]initWithFrame:CGRectMake(5, 325, self.view.frame.size.width-150, 35)];<br/> outputLabel.font = [UIFont fontWithName:@"TimesNewRomanPSMT" size:12]; //custom font<br/> outputLabel.backgroundColor = [UIColor clearColor];<br/> outputLabel.numberOfLines=2;<br/> outputLabel.textColor = [UIColor blackColor];<br/> outputLabel.textAlignment = NSTextAlignmentLeft;<br/> outputLabel.text = [responseDictionary valueForKey:@""];<br/> [self.view addSubview:outputLabel];<br/> }</pre>
<p>The app can now run and is ready to be tested on the simulator.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Additional notes</h1>
                </header>
            
            <article>
                
<p>This was a demonstration of how we can use AI models on an iOS device. Having said that, there are a lot of tasks that can be added to the existing app:</p>
<ul>
<li>Improve the UI design</li>
<li>Add input checks to validate the data entered</li>
<li>Host the Flask app (Heroku, AWS, and more)</li>
<li>Publish the app</li>
</ul>
<p>All these tasks are independent of our core AI theme, so they can be addressed as an exercise for the reader. The complete code and project files for both the Android and iOS apps are available as <kbd>chapter2_android_prediction</kbd> and <kbd>chapter2_ios_prediction</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we explored the<span> basic sequential network and consumed it on mobile devices. In the next chapter, we will take a look at a special kind of network called <strong>Convolutional Neural Networks</strong> (<strong>CNN</strong>). CNNs are the most common networks used with Machine Vision. Our goal in the next chapter is to get comfortable with machine vision and to build our own custom-purpose CNNs.</span></p>


            </article>

            
        </section>
    </body></html>